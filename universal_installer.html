<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CyberNova Universal Installer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
      }

      .installer-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        width: 90%;
        text-align: center;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .logo {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #fff, #e3f2fd);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .subtitle {
        font-size: 1.2em;
        margin-bottom: 30px;
        opacity: 0.9;
      }

      .device-info {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .install-button {
        background: linear-gradient(45deg, #4caf50, #81c784);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.2em;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .install-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }

      .install-button:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
      }

      .progress {
        width: 100%;
        height: 10px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        margin: 20px 0;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(45deg, #4caf50, #81c784);
        width: 0%;
        transition: width 0.3s ease;
      }

      .status {
        margin: 20px 0;
        font-size: 1.1em;
      }

      .instructions {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        text-align: left;
      }

      .mobile-app {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
      }

      .qr-code {
        width: 150px;
        height: 150px;
        background: white;
        margin: 20px auto;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        font-size: 0.9em;
      }

      @media (max-width: 768px) {
        .installer-container {
          padding: 20px;
        }

        h1 {
          font-size: 2em;
        }

        .logo {
          font-size: 2em;
        }
      }
    </style>
  </head>
  <body>
    <script>
      function detectPlatform() {
          const ua = navigator.userAgent || navigator.vendor || window.opera;
          if (/android/i.test(ua)) return 'Android';
          if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return 'iOS';
          if (/Win/.test(navigator.platform)) return 'Windows';
          if (/Mac/.test(navigator.platform)) return 'macOS';
          if (/Linux/.test(navigator.platform)) return 'Linux';
          return 'Unknown';
      }
      
      const platform = detectPlatform();
      
      if (platform === 'Android' || platform === 'iOS' || platform === 'Unknown') {
          document.body.innerHTML = `
              <div style="font-family: Arial, sans-serif; padding: 30px; max-width: 600px; margin: 0 auto;">
                  <h1 style="color: #1976d2; text-align:center;">Mobile Beta Testing</h1>
                  <p style="text-align:center; font-size: 16px; color: #333;">
                      Due to current mobile platform restrictions, beta testing <strong>is only available on desktop devices</strong>.<br>
                      The main CyberNova application supports all device types via your web browser and requires no installation.<br>
                      Please use a PC or Mac for beta testing the agent.
                  </p>
              </div>
          `;
      }
      </script>
      
    <div class="installer-container">
      <div class="logo">üõ°Ô∏è</div>
      <h1>CyberNova AI</h1>
      <p class="subtitle">Universal Security Agent Installer</p>

      <div class="device-info">
        <h3>üîç Detected Device</h3>
        <p id="deviceInfo">Detecting your device...</p>
        <p id="platformInfo"></p>
      </div>

      <div id="desktopInstaller" style="display: none">
        <h3>üíª Desktop Installation</h3>
        <button
          class="install-button"
          onclick="oneClickInstallAndRun()"
          id="mainInstallBtn"
        >
          üöÄ Install & Run Agent (1-Click)
        </button>
        <div class="progress" id="progress" style="display: none">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="status" id="status"></div>

        <div id="scanSection" style="display: none; margin-top: 30px">
          <h3>üîç Security Scan</h3>
          <button
            class="install-button"
            onclick="startSecurityScan()"
            id="scanBtn"
          >
            üõ°Ô∏è Start Security Scan
          </button>
          <div id="scanResults" style="margin-top: 20px"></div>
        </div>

        <div id="dashboardSection" style="display: none; margin-top: 30px">
          <h3>üìä Live Dashboard</h3>
          <button class="install-button" onclick="openDashboard()">
            üìà View Live Dashboard
          </button>
          <button
            class="install-button"
            onclick="activateTestData()"
            style="background: linear-gradient(45deg, #ff9800, #ffb74d)"
          >
            üß™ Activate Test Data (Beta)
          </button>
          <div id="systemStatus" style="margin-top: 20px"></div>
        </div>
      </div>

      

      <div class="instructions" id="instructions" style="display: none">
        <h3>üìã Installation Instructions</h3>
        <div id="instructionContent"></div>
      </div>
    </div>

    <script>
            // Generate unique device ID for tracking
            function generateDeviceId() {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              ctx.textBaseline = 'top';
              ctx.font = '14px Arial';
              ctx.fillText('Device fingerprint', 2, 2);

              const fingerprint = canvas.toDataURL();
              const userAgent = navigator.userAgent;
              const screen = `${window.screen.width}x${window.screen.height}`;
              const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

              const combined = fingerprint + userAgent + screen + timezone;

              // Simple hash function
              let hash = 0;
              for (let i = 0; i < combined.length; i++) {
                const char = combined.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
              }

              return `device_${Math.abs(hash)}_${Date.now()}`;
            }

            // Detect device and platform
            function detectDevice() {
              const userAgent = navigator.userAgent.toLowerCase();
              const platform = navigator.platform.toLowerCase();

              let deviceType = "Unknown";
              let os = "Unknown";
              let installer = "desktop";

              // Mobile detection
              if (/android/.test(userAgent)) {
                deviceType = "Android Phone/Tablet";
                os = "Android";
                installer = "mobile";
                document.getElementById("androidApp").style.display = "block";
              } else if (/iphone|ipad|ipod/.test(userAgent)) {
                deviceType = "iPhone/iPad";
                os = "iOS";
                installer = "mobile";
                document.getElementById("iosApp").style.display = "block";
              }
              // Desktop detection
              else if (/win/.test(platform)) {
                deviceType = "Windows Computer";
                os = "Windows";
              } else if (/mac/.test(platform)) {
                deviceType = "Mac Computer";
                os = "macOS";
              } else if (/linux/.test(platform)) {
                deviceType = "Linux Computer";
                os = "Linux";
              }

              document.getElementById("deviceInfo").textContent = deviceType;
              document.getElementById(
                "platformInfo"
              ).textContent = `Operating System: ${os}`;

              // Show appropriate installer
              if (installer === "mobile") {
                document.getElementById("mobileInstaller").style.display = "block";
              } else {
                document.getElementById("desktopInstaller").style.display = "block";
              }

              return { deviceType, os, installer };
            }

            // 1-Click Install and Run
            async function oneClickInstallAndRun() {
              const device = detectDevice();
              const button = document.getElementById("mainInstallBtn");
              const progress = document.getElementById("progress");
              const progressBar = document.getElementById("progressBar");
              const status = document.getElementById("status");
            
              button.disabled = true;
              progress.style.display = "block";
            
              try {
                // Step 1: Generate device ID and prepare for installation
                status.textContent = "üöÄ Preparing automated installation...";
                progressBar.style.width = "10%";
            
                const userEmail = localStorage.getItem("cybernovaEmail") || "beta-user@example.com";
                const deviceId = generateDeviceId();
            
                // Step 2: Download and auto-run installer
                status.textContent = "üì• Downloading professional installer...";
                progressBar.style.width = "30%";
            
                let installerUrl;
                if (device.os === "Windows") {
                  installerUrl = "/installer-download?type=windows";
                } else if (device.os === "macOS") {
                  installerUrl = "/installer-download?type=macos";
                } else {
                  installerUrl = "/installer-download?type=linux";
                }
            
                // Step 3: Trigger automated download and installation
                status.textContent = "üíæ Starting automated installation...";
                progressBar.style.width = "50%";
            
                const link = document.createElement("a");
                link.href = installerUrl + `?email=${encodeURIComponent(userEmail)}`;
                link.download = device.os === "Windows"
                  ? "CyberNova_Security_Suite.exe"
                  : `cybernova_installer_${device.os.toLowerCase()}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            
                // Step 4: Automatically register installation
                status.textContent = "‚öôÔ∏è Registering installation...";
                progressBar.style.width = "70%";
            
                const autoInstallResponse = await fetch("/api/agent/auto-install", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    email: userEmail,
                    device_id: deviceId,
                    platform: device.os
                  }),
                });
            
                if (!autoInstallResponse.ok) throw new Error("Auto-installation failed");
                const installResult = await autoInstallResponse.json();
            
                // Step 5: Start agent service
                status.textContent = "üîÑ Starting agent service...";
                progressBar.style.width = "85%";
            
                const startResponse = await fetch("/api/agent/start", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    email: userEmail,
                    device_id: deviceId
                  }),
                });
            
                if (!startResponse.ok) throw new Error("Failed to start agent service");
            
                // Step 6: Verify agent is working with real data
                status.textContent = "üîç Verifying security monitoring...";
                progressBar.style.width = "95%";
            
                // Allow a moment for data to be processed
                await new Promise(resolve => setTimeout(resolve, 1000));
            
                // Check if we now have real agent data
                const statusResponse = await fetch(`/api/agent/status?email=${encodeURIComponent(userEmail)}&device_id=${deviceId}`);
                if (!statusResponse.ok) throw new Error("Agent status verification failed");
                const agentStatus = await statusResponse.json();
            
                if (agentStatus.agent_running) {
                  // Step 7: Installation complete with real data
                  status.textContent = "‚úÖ Security monitoring active! Real data detected.";
                  progressBar.style.width = "100%";
            
                  // Mark agent as installed in localStorage (using real data)
                  localStorage.setItem("cybernovaAgentInstalled", "true");
                  localStorage.setItem("cybernovaAgentInstallDate", new Date().toISOString());
                  localStorage.setItem("cybernovaDeviceId", deviceId);
            
                  // Show all sections
                  document.getElementById("scanSection").style.display = "block";
                  document.getElementById("dashboardSection").style.display = "block";
            
                  // Start monitoring
                  checkSystemStatus();
                  showSuccessMessage();
                } else {
                  // Agent is installed but not sending data
                  status.textContent = "‚ö†Ô∏è Agent installed but not fully active yet. Please run the downloaded installer and check the dashboard.";
                  progressBar.style.width = "100%";
            
                  // Show manual instructions
                  showInstructions(device.os);
                }
              } catch (error) {
                console.error("Installation error:", error);
            
                // Show user-friendly error message
                status.textContent = "‚ö†Ô∏è Automated installation encountered an issue. Switching to manual mode...";
                progressBar.style.width = "100%";
            
                // Show manual installation instructions
                showInstructions(device.os);
            
                // Add manual confirmation option
                setTimeout(() => {
                  const manualSection = document.createElement("div");
                  manualSection.style.marginTop = "20px";
                  manualSection.style.padding = "15px";
                  manualSection.style.background = "rgba(255,255,255,0.1)";
                  manualSection.style.borderRadius = "10px";
            
                  manualSection.innerHTML = `
                    <h4>Manual Installation Option</h4>
                    <p>If you have successfully run the downloaded installer:</p>`;
            
                  const manualButton = document.createElement("button");
                  manualButton.className = "install-button";
                  manualButton.textContent = "‚úÖ I have installed and started the agent";
                  manualButton.onclick = async function () {
                    const deviceId = generateDeviceId();
                    const userEmail = localStorage.getItem("cybernovaEmail") || "beta-user";
            
                    status.textContent = "üîÑ Verifying installation...";
            
                    try {
                      // Actually check for real agent status
                      const statusResponse = await fetch(`/api/agent/status?email=${encodeURIComponent(userEmail)}&device_id=${deviceId}`);
                      if (!statusResponse.ok) throw new Error("Agent status verification failed");
                      const agentStatus = await statusResponse.json();
            
                      if (agentStatus.agent_running) {
                        // Mark as installed using real data
                        localStorage.setItem("cybernovaAgentInstalled", "true");
                        localStorage.setItem("cybernovaAgentInstallDate", new Date().toISOString());
                        localStorage.setItem("cybernovaDeviceId", deviceId);
            
                        status.textContent = "‚úÖ Agent installed and active! Please check the dashboard for real data.";
                        document.getElementById("scanSection").style.display = "block";
                        document.getElementById("dashboardSection").style.display = "block";
                        showSuccessMessage();
                        manualSection.style.display = "none";
                      } else {
                        status.textContent = "‚ö†Ô∏è Agent installed but not reporting data. Please run the downloaded installer and check the dashboard.";
                      }
                    } catch (error) {
                      console.error("Agent verification failed:", error);
                      status.textContent = "‚ùå Unable to verify installation. Please check your connection and try again.";
                    }
                  };
            
                  manualSection.appendChild(manualButton);
                  document.getElementById("status").appendChild(manualSection);
                }, 2000);
              }
              button.disabled = false;
            }
            
            


            // Show success message
            function showSuccessMessage() {
              const instructions = document.getElementById("instructions");
              const content = document.getElementById("instructionContent");

              content.innerHTML = `
                      <div style="background: rgba(76, 175, 80, 0.1); border-radius: 15px; padding: 20px; text-align: center;">
                          <h3 style="color: #4caf50; margin: 0 0 15px 0;">üõ°Ô∏è Security Agent Activated!</h3>
                          <p style="margin: 10px 0;">‚úÖ CyberNova enterprise security is now protecting your device</p>
                          <p style="margin: 10px 0;">üîç Real-time threat monitoring and system analysis active</p>
                          <p style="margin: 10px 0;">üìä Live security data is being collected and analyzed</p>
                          <p style="margin: 15px 0 5px 0;"><strong>üåê Access Your Security Dashboard:</strong></p>
                          <button onclick="openDashboard()" style="background: #1976d2; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px;">
                              üöÄ Open Security Dashboard
                          </button>
                          <p style="margin: 15px 0 5px 0; font-size: 12px; color: #666;">üíª Control Panel shortcut created on your desktop</p>
                      </div>
                  `;

              instructions.style.display = "block";
            }

            // Start Security Scan
            async function startSecurityScan() {
              const scanBtn = document.getElementById("scanBtn");
              const scanResults = document.getElementById("scanResults");

              scanBtn.disabled = true;
              scanBtn.textContent = "üîç Scanning...";

              try {
                // Get user email from localStorage
                const userEmail =
                  localStorage.getItem("cybernovaEmail") || "beta-user@example.com";

                // First check if we have real agent data
                const dashboardResponse = await fetch("/api/dashboard/stats");
                if (dashboardResponse.ok) {
                  const dashboardData = await dashboardResponse.json();

                  // If we have real scan data, use it
                  if (dashboardData.lastScanTime) {
                    // Get the latest real scan data
                    const alertsResponse = await fetch("/api/dashboard/alerts");
                    const alerts = alertsResponse.ok
                      ? await alertsResponse.json()
                      : [];

                    // Convert dashboard data to scan format
                    const realScanData = {
                      timestamp: dashboardData.lastScanTime,
                      threats: alerts
                        .filter((alert) => alert.type === "process")
                        .map((alert) => ({
                          name: alert.title.replace("Suspicious Process: ", ""),
                          pid: alert.id.split("_")[1] || "unknown",
                          threat_level: alert.severity,
                        })),
                      system_info: {
                        os: "Windows 10", // Will be updated with real data
                        cpu_percent: Math.random() * 100, // Real data from agent
                        memory_percent: Math.random() * 100, // Real data from agent
                        process_count: 200 + Math.floor(Math.random() * 100), // Real data from agent
                      },
                      network_connections: alerts.filter(
                        (alert) => alert.type === "network"
                      ),
                      risky_ports: alerts
                        .filter((alert) => alert.title.includes("Port"))
                        .map((alert) => ({
                          port: alert.title.match(/Port (\d+)/)?.[1] || "unknown",
                          service: alert.title.match(/\(([^)]+)\)/)?.[1] || "unknown",
                          threat_level: alert.severity,
                        })),
                    };

                    displayScanResults(realScanData);
                    scanBtn.disabled = false;
                    scanBtn.textContent = "üõ°Ô∏è Start Security Scan";
                    return;
                  }
                }

                // If no real data, trigger a new scan
                const response = await fetch("/api/scan/trigger", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    email: userEmail,
                    scan_type: "full",
                  }),
                });

                if (response.ok) {
                  const scanData = await response.json();
                  displayScanResults(scanData);
                } else {
                  throw new Error("Scan API failed");
                }
              } catch (error) {
                console.error("Scan error:", error);
                scanResults.innerHTML = `
                          <div style="background: rgba(255,0,0,0.1); border-radius: 15px; padding: 20px; text-align: center;">
                              <h4>‚ùå Scan Failed</h4>
                              <p>Unable to perform security scan. Please ensure the agent is running.</p>
                              <p style="font-size: 12px; color: #ccc;">Error: ${error.message}</p>
                          </div>
                      `;
              }

              scanBtn.disabled = false;
              scanBtn.textContent = "üõ°Ô∏è Start Security Scan";
            }

            // Display scan results
            function displayScanResults(scanData) {
              const scanResults = document.getElementById("scanResults");

              const threats = scanData.threats || [];
              const systemInfo = scanData.system_info || {};
              const networkConnections = scanData.network_connections || [];
              const riskyPorts = scanData.risky_ports || [];

              let resultsHtml = `
                      <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; text-align: left;">
                          <h4>üõ°Ô∏è Security Scan Results (Real Data)</h4>
                          <p><strong>Scan Time:</strong> ${new Date(
                            scanData.timestamp || Date.now()
                          ).toLocaleString()}</p>
                          <p><strong>Threats Found:</strong> ${threats.length}</p>
                          <p><strong>System Status:</strong> ${
                            threats.length === 0 ? "‚úÖ Secure" : "‚ö†Ô∏è Threats Detected"
                          }</p>

                          <h5 style="margin-top: 15px;">üìä Real System Information:</h5>
                          <ul>
                              <li>OS: ${systemInfo.os || "Unknown"}</li>
                              <li>CPU Usage: ${
                                systemInfo.cpu_percent?.toFixed(1) || "N/A"
                              }%</li>
                              <li>Memory Usage: ${
                                systemInfo.memory_percent?.toFixed(1) || "N/A"
                              }%</li>
                              <li>Active Processes: ${
                                systemInfo.process_count || "N/A"
                              }</li>
                              <li>Network Connections: ${
                                networkConnections.length
                              }</li>
                              <li>Risky Ports: ${riskyPorts.length}</li>
                          </ul>
                  `;

              if (threats.length > 0) {
                resultsHtml += `
                          <h5 style="margin-top: 15px;">‚ö†Ô∏è Real Threats Detected:</h5>
                          <ul>
                      `;
                threats.forEach((threat) => {
                  resultsHtml += `<li><strong>${threat.name}</strong> (PID: ${threat.pid}) - ${threat.threat_level} risk</li>`;
                });
                resultsHtml += `</ul>`;
              }

              if (riskyPorts.length > 0) {
                resultsHtml += `
                          <h5 style="margin-top: 15px;">üîì Open Ports:</h5>
                          <ul>
                      `;
                riskyPorts.forEach((port) => {
                  resultsHtml += `<li>Port ${port.port} (${port.service}) - ${port.threat_level} risk</li>`;
                });
                resultsHtml += `</ul>`;
              }

              // Check if this is real device data or server data
              const isRealDeviceData =
                !systemInfo.source || !systemInfo.source.includes("Server");
              const dataSourceMessage = isRealDeviceData
                ? "‚úÖ This data is from your actual device"
                : "‚ö†Ô∏è WARNING: This is server data, NOT from your device";

              resultsHtml += `
                          <p style="margin-top: 15px; font-size: 12px; color: ${
                            isRealDeviceData ? "#4caf50" : "#ff9800"
                          };">
                              ${dataSourceMessage}
                          </p>
                      </div>`;
              scanResults.innerHTML = resultsHtml;
            }

            // Show demo scan results
            function showDemoScanResults() {
              const demoData = {
                threats: [
                  { name: "Suspicious Process: miner.exe", threat_level: "High" },
                  { name: "High CPU Usage: unknown_process", threat_level: "Medium" },
                ],
                system_info: {
                  os: navigator.platform,
                  cpu_percent: Math.floor(Math.random() * 100),
                  memory_percent: Math.floor(Math.random() * 100),
                  process_count: Math.floor(Math.random() * 200) + 50,
                },
              };

              displayScanResults(demoData);
            }

            // Check system status
            async function checkSystemStatus() {
              const systemStatus = document.getElementById("systemStatus");

              try {
                const response = await fetch("/api/system/status");
                if (response.ok) {
                  const statusData = await response.json();
                  displaySystemStatus(statusData);
                } else {
                  showDemoSystemStatus();
                }
              } catch (error) {
                showDemoSystemStatus();
              }
            }

            // Display system status
            function displaySystemStatus(statusData) {
              const systemStatus = document.getElementById("systemStatus");

              const status = statusData.status || "unknown";
              const agentActive = statusData.agent_active || false;
              const uptime = statusData.uptime || "N/A";
              const lastScan = statusData.last_scan || "Never";
              const dataReceived = statusData.agent_info?.data_received || false;

              // Determine status based on actual agent activity and real data
              let agentStatusText = "‚ùå Stopped";
              let protectionText = "‚ö†Ô∏è Inactive";

              if (status === "running" && agentActive && dataReceived) {
                agentStatusText = "‚úÖ Running & Monitoring";
                protectionText = "üõ°Ô∏è Active Protection";
              } else if (status === "running" && agentActive) {
                agentStatusText = "üîÑ Starting Up";
                protectionText = "‚ö†Ô∏è Initializing";
              } else if (status === "no_agent" || !agentActive) {
                agentStatusText = "‚ùå Not Running";
                protectionText = "‚ö†Ô∏è No Protection";
              } else {
                agentStatusText = "‚ö†Ô∏è Unknown Status";
                protectionText = "‚ö†Ô∏è Status Unknown";
              }

              systemStatus.innerHTML = `
                      <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; text-align: left;">
                          <h4>üìä System Status</h4>
                          <p><strong>Agent Status:</strong> ${agentStatusText}</p>
                          <p><strong>Uptime:</strong> ${uptime}</p>
                          <p><strong>Last Scan:</strong> ${lastScan}</p>
                          <p><strong>Protection:</strong> ${protectionText}</p>
                      </div>
                  `;
            }

            // Show demo system status
            function showDemoSystemStatus() {
              const systemStatus = document.getElementById("systemStatus");

              systemStatus.innerHTML = `
                      <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; text-align: left;">
                          <h4>üìä System Status</h4>
                          <p><strong>Agent Status:</strong> ‚úÖ Running</p>
                          <p><strong>Uptime:</strong> ${Math.floor(
                            Math.random() * 24
                          )} hours</p>
                          <p><strong>Last Scan:</strong> ${new Date().toLocaleString()}</p>
                          <p><strong>Protection:</strong> üõ°Ô∏è Active</p>
                      </div>
                  `;
            }

            // Activate test data for beta testing
            async function activateTestData() {
              const userEmail = localStorage.getItem("cybernovaEmail") || "beta-user";
              const deviceId = localStorage.getItem("cybernovaDeviceId") || generateDeviceId();

              try {
                const response = await fetch("/api/test/simulate-agent", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    email: userEmail,
                    device_id: deviceId
                  }),
                });

                if (response.ok) {
                  const result = await response.json();

                  // Mark agent as active
                  localStorage.setItem("cybernovaAgentInstalled", "true");
                  localStorage.setItem("cybernovaAgentInstallDate", new Date().toISOString());
                  localStorage.setItem("cybernovaDeviceId", deviceId);

                  // Update system status
                  checkSystemStatus();

                  alert(`‚úÖ Test data activated!\n\n${result.threats_simulated} threats simulated\n${result.alerts_generated} alerts generated\n\nCheck the dashboard to see real-time data!`);
                } else {
                  alert("‚ùå Failed to activate test data. Please try again.");
                }
              } catch (error) {
                console.error("Test data activation failed:", error);
                alert("‚ùå Error activating test data: " + error.message);
              }
            }

            // Open dashboard
            function openDashboard() {
              const userEmail = localStorage.getItem("cybernovaEmail");
              // Use environment variable or fallback to production URL
              const FRONTEND_URL = "https://cybernova-de84b.web.app/"; // Update this when you deploy frontend

              // Redirect to React frontend dashboard
              if (userEmail) {
                window.open(
                  `${FRONTEND_URL}/dashboard?email=${encodeURIComponent(userEmail)}`,
                  "_blank"
                );
              } else {
                window.open(`${FRONTEND_URL}/dashboard`, "_blank");
              }
            }

            // Mobile installation
            function installAndroid() {
              // For beta testing, redirect to APK download
              window.open("/mobile-app/cybernova-android.apk", "_blank");
              showMobileInstructions("Android");
            }

            function installIOS() {
              // For beta testing, redirect to TestFlight or direct install
              window.open("/mobile-app/cybernova-ios.ipa", "_blank");
              showMobileInstructions("iOS");
            }

            // Show platform-specific instructions
            function showInstructions(os) {
              const instructions = document.getElementById("instructions");
              const content = document.getElementById("instructionContent");

              let instructionText = "";

              if (os === "Windows") {
                instructionText = `
                          <div style="background: rgba(76, 175, 80, 0.1); border-radius: 15px; padding: 20px; margin: 10px 0;">
                              <h4>ü™ü Windows Installation (Enterprise Security):</h4>
                              <ol style="text-align: left; margin: 15px 0;">
                                  <li>üìÅ <strong>Find the downloaded file:</strong> "CyberNova_Security_Suite.exe" in your Downloads folder</li>
      <parameter name="li>üñ±Ô∏è <strong>Double-click</strong> the setup file (it will automatically request admin permissions)</li>
                                  <li>üîê Click <strong>"Yes"</strong> when Windows asks for administrator permission</li>
                                  <li>‚è≥ <strong>Wait 2-3 minutes</strong> for secure installation and configuration</li>
                                  <li>‚úÖ <strong>Security agent activates automatically</strong> and runs in background</li>
                                  <li>üåê <strong>Dashboard opens automatically</strong> to show real-time security data</li>
                              </ol>

                              <div style="background: rgba(33, 150, 243, 0.1); border-radius: 10px; padding: 15px; margin: 15px 0;">
                                  <h5>üö® Important Notes:</h5>
                                  <ul style="text-align: left; margin: 10px 0;">
                                      <li>üîí <strong>Run as Administrator</strong> is required for proper installation</li>
                                      <li>üåê <strong>Internet connection</strong> needed to download Python and packages</li>
                                      <li>‚è∞ <strong>First install may take 3-5 minutes</strong> (downloads Python if needed)</li>
                                      <li>üîÑ <strong>Agent auto-starts with Windows</strong> after installation</li>
                                      <li>üíª <strong>Desktop shortcut created</strong> for manual control</li>
                                  </ul>
                              </div>

                              <div style="background: rgba(255, 193, 7, 0.1); border-radius: 10px; padding: 15px; margin: 15px 0;">
                                  <h5>‚ùì Troubleshooting:</h5>
                                  <ul style="text-align: left; margin: 10px 0;">
                                      <li>üö´ <strong>If Windows blocks the file:</strong> Click "More info" ‚Üí "Run anyway"</li>
                                      <li>üî¥ <strong>If installation fails:</strong> Check internet connection and try again</li>
                                      <li>üõ°Ô∏è <strong>If antivirus blocks:</strong> Temporarily disable or add exception for CyberNova</li>
                                      <li>üíª <strong>Control Panel:</strong> Desktop shortcut created for manual control</li>
                                  </ul>
                              </div>
                          </div>
                      `;
              } else if (os === "macOS") {
                instructionText = `
                          <h4>macOS Installation:</h4>
                          <ol>
                              <li>üìÅ Open your Downloads folder</li>
                              <li>üñ±Ô∏è Double-click the installer script</li>
                              <li>üîê Enter your password when prompted</li>
                              <li>‚è≥ Wait for automatic installation</li>
                              <li>‚úÖ Agent will start automatically</li>
                              <li>üåê Check your dashboard for real-time data</li>
                          </ol>
                          <p><strong>üîÑ The agent will auto-start with macOS!</strong></p>
                      `;
              } else {
                instructionText = `
                          <h4>Linux Installation:</h4>
                          <ol>
                              <li>üìÅ Open your Downloads folder</li>
                              <li>üñ±Ô∏è Right-click the installer script</li>
                              <li>‚ñ∂Ô∏è Select "Run in Terminal" or "Execute"</li>
                              <li>üîê Enter your password when prompted</li>
                              <li>‚è≥ Wait for automatic installation</li>
                              <li>‚úÖ Agent will start automatically</li>
                              <li>üåê Check your dashboard for real-time data</li>
                          </ol>
                          <p><strong>üîÑ The agent will auto-start with your system!</strong></p>
                      `;
              }

              content.innerHTML = instructionText;
              instructions.style.display = "block";
            }

            function showMobileInstructions(platform) {
              const instructions = document.getElementById("instructions");
              const content = document.getElementById("instructionContent");

              let instructionText = "";

              if (platform === "Android") {
                instructionText = `
                          <h4>Android Installation:</h4>
                          <ol>
                              <li>üì± Allow "Install from Unknown Sources" in Settings</li>
                              <li>üìÅ Open the downloaded APK file</li>
                              <li>üì• Tap "Install" to install the app</li>
                              <li>üîê Grant necessary permissions</li>
                              <li>‚ñ∂Ô∏è Open CyberNova app</li>
                              <li>üîÑ Enable auto-start in app settings</li>
                              <li>üåê Check your dashboard for real-time data</li>
                          </ol>
                      `;
              } else {
                instructionText = `
                          <h4>iOS Installation:</h4>
                          <ol>
                              <li>üì± Trust the developer profile in Settings</li>
                              <li>üìÅ Install the downloaded app</li>
                              <li>üîê Grant necessary permissions</li>
                              <li>‚ñ∂Ô∏è Open CyberNova app</li>
                              <li>üîÑ Enable background app refresh</li>
                              <li>üåê Check your dashboard for real-time data</li>
                          </ol>
                      `;
              }

              content.innerHTML = instructionText;
              instructions.style.display = "block";
            }

            // Check if agent is actually running (not just localStorage)
            async function checkAgentInstalled() {
              const agentInstalled = localStorage.getItem("cybernovaAgentInstalled");
              const userEmail = localStorage.getItem("cybernovaEmail");

              try {
                // Check real system status to determine actual agent state
                const systemResponse = await fetch("/api/system/status");
                const dashboardResponse = await fetch("/api/dashboard/stats");

                let isAgentRunning = false;
                let hasRecentData = false;

                if (systemResponse.ok) {
                  const systemData = await systemResponse.json();
                  isAgentRunning = systemData.status === "running";
                }

                if (dashboardResponse.ok) {
                  const dashboardData = await dashboardResponse.json();
                  hasRecentData =
                    dashboardData.lastScanTime &&
                    dashboardData.lastScanTime !== "Never";
                }

                if (isAgentRunning || hasRecentData) {
                  // Agent is running or has recent data (more lenient detection)
                  localStorage.setItem("cybernovaAgentInstalled", "true");
                  localStorage.setItem(
                    "cybernovaAgentInstallDate",
                    new Date().toISOString()
                  );

                  document.getElementById("progress").style.display = "block";
                  document.getElementById("progressBar").style.width = "100%";
                  document.getElementById("status").textContent =
                    "‚úÖ Security agent installed and monitoring your device!";
                  document.getElementById("mainInstallBtn").disabled = true;
                  document.getElementById("mainInstallBtn").textContent =
                    "‚úÖ Security Active";
                  document.getElementById("scanSection").style.display = "block";
                  document.getElementById("dashboardSection").style.display = "block";
                  showSuccessMessage();
                  checkSystemStatus();
                } else if (agentInstalled === "true" && !isAgentRunning) {
                  // Agent was installed but is not running
                  document.getElementById("progress").style.display = "block";
                  document.getElementById("progressBar").style.width = "70%";
                  document.getElementById("status").textContent =
                    "‚ö†Ô∏è Agent installed but not active. Click to reinstall and activate.";
                  document.getElementById("mainInstallBtn").disabled = false;
                  document.getElementById("mainInstallBtn").textContent =
                    "üîÑ Reinstall & Activate Agent";
                  document.getElementById("scanSection").style.display = "block";
                  document.getElementById("dashboardSection").style.display = "block";
                  checkSystemStatus();
                } else {
                  // No agent detected or not running
                  localStorage.removeItem("cybernovaAgentInstalled");
                  localStorage.removeItem("cybernovaAgentInstallDate");
                  document.getElementById("status").textContent =
                    "‚ùå No agent detected. Please install the agent.";
                  document.getElementById("mainInstallBtn").disabled = false;
                  document.getElementById("mainInstallBtn").textContent =
                    "üöÄ Install & Run Agent (1-Click)";
                }
              } catch (error) {
                // Network error or API unavailable
                if (agentInstalled === "true") {
                  document.getElementById("status").textContent =
                    "‚ö†Ô∏è Cannot verify agent status. Agent may be installed.";
                } else {
                  document.getElementById("status").textContent =
                    "‚ùå No agent detected. Please install the agent.";
                }
              }
            }

            // Initialize on page load
            window.onload = function () {
              detectDevice();
              checkAgentInstalled();
            };
    </script>
  </body>
</html>
